<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script type='text/javascript' src='./qwebchannel.js'></script>
        <script type='text/javascript' src='http://api.map.baidu.com/api?v=1.3&ak=gtUDcX7BrzZADD2dWMFE1RgF6IkL3t2I'></script>
    </head>

    <style type="text/css">
        html,body { height: 100%; padding: 0; margin: 0; font-size: 11px}
        .header { height: 100px; background: #BBE8F2; position: absolute; top: 0 ; left: 0 ; width: 100%; }
        .content { height: 100%; box-sizing: border-box; border-top:100px solid transparent; background: #D9C666;}
    </style>

    <body>
        <div class="header">
            <script>
                function onDrive() {
                    map.clearOverlays();
                    var startPlace = document.getElementById('startInput').value;
                    var endPlace = document.getElementById('endInput').value;
                    searchDrivingRoute(startPlace, endPlace, false, function(success, results) {
                        if(success) {
                            document.getElementById("places").innerText = startPlace + ', ' + endPlace;
                            document.getElementById("result").innerText = '总共：' + results.getPlan(0).getDistance() + ', 需要：' + results.getPlan(0).getDuration();
                        }
                    });
                }
            </script>

            从&nbsp;<input id="startInput" type="text" value="广州从化汽车站"/>&nbsp;到&nbsp;<input id="endInput" type="text" value="广州火车站"/>&nbsp;&nbsp;<input type="button" value="路线规划" onclick="onDrive()"/>
            <div id="result">&nbsp;</div>
            <div id="places">&nbsp;</div>
        </div>
            <div class="content">
                <div id="mapContainer" style="height: 100%;"></div>
            </div>
    </body>
</html>

<script type="text/javascript">
    "use strict";

    var map = new BMap.Map("mapContainer");                 // 创建Map实例
    var point = new BMap.Point(113.30764968, 23.1200491);   // 创建点坐标
    map.centerAndZoom(point, 12);                           // 初始化地图,设置中心点坐标和地图级别。
    map.enableScrollWheelZoom();                            // 启用滚轮放大缩小
    map.enableKeyboard();                                   // 启用键盘操作
    map.enableContinuousZoom();                             // 启用连续缩放
    map.addControl(new BMap.ScaleControl());                // 添加比例尺控件
    map.addControl(new BMap.NavigationControl());           // 添加地图导航尺
    map.addControl(new BMap.OverviewMapControl());          // 添加缩略地图控件
    map.addControl(new BMap.MapTypeControl());              // 添加地图显示类型控件

/*
    (new BMap.Geolocation()).getCurrentPosition(function(geo) {
        if(geo != null) { map.panTo(geo.point); }
    });*/

    function searchDrivingRoute(startPlace, endPlace, autoClear, reslutCallback) {
        //if((typeof startPlace != 'string') || (typeof endPlace != 'string') || (typeof reslutCallback != 'function'))

        var drivingRoute = new BMap.DrivingRoute(map, {
            renderOptions: {
                    map: map,
                    autoViewport: true
                },
            /*policy: BMAP_DRIVING_POLICY_LEAST_TIME*/
        });

        drivingRoute.setSearchCompleteCallback(function(results) {
            if(reslutCallback != null) {
                reslutCallback(true, results);
            }
            if(autoClear) {
                drivingRoute.clearResults();
            }
        });

        var startPoint = null;
        var endPoint = null;

        //创建2个搜索实例
        var searchStartPoint = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                if (searchStartPoint.getStatus() == BMAP_STATUS_SUCCESS) { // 判断状态是否正确
                    startPoint = results.getPoi(0).point;
                } else {
                    if(reslutCallback != null) {
                        reslutCallback(false);
                    }
                }
                if((startPoint != null) && (endPoint != null)) {
                    drivingRoute.search(startPoint, endPoint);
                }
            }
        });
        var searchEndPoint = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                if (searchEndPoint.getStatus() == BMAP_STATUS_SUCCESS) {
                    endPoint = results.getPoi(0).point;
                } else {
                    if(reslutCallback != null) {
                        reslutCallback(false);
                    }
                }
                if((startPoint != null) && (endPoint != null)) {
                    drivingRoute.search(startPoint, endPoint);
                }
            }
        });

        searchStartPoint.search(startPlace);
        searchEndPoint.search(endPlace);
    }

    new QWebChannel(window.qt.webChannelTransport, function(channel) {
        window.core = channel.objects.Mainwindow;

        window.core.getMapDriveRoute.connect(function(usrData, startPlace, endPlace) {
            searchDrivingRoute(startPlace, endPlace, true, function(success, results) {
                window.core.updateMapDriveRoute(usrData, success ? (results.getNumPlans() > 0) : false,
                                                         success ? results.getPlan(0).getDistance():0,
                                                         success ? results.getPlan(0).getDuration():0);
            });
        });

        window.core.getMapDriveRoutes.connect( function(usrData, placeSet, seq) {
            var placeList = placeSet.split(seq);

            document.getElementById("places").innerText = placeList;
            //var calculatingWindow = window.showModalDialog();

            var paths = [];
            var endpoints = [];

            var distances = [];
            var durations = [];
            function searchNextDrivingRoute(i) {
                if(i <= placeList.length-2) {
                    var startPlace = placeList[i].trim();
                    var endPlace = placeList[i+1].trim();
                    searchDrivingRoute(startPlace, endPlace, true, function(success, results) {
                        if(success) {
                            if(i == 0) {
                                endpoints.push({place: '起:'+startPlace, resultPoi:results.getStart()});
                            }
                            if(i < placeList.length-2) {
                                endpoints.push({place: (i+1)+':'+endPlace, resultPoi:results.getEnd()});
                            } else {
                                endpoints.push({place: '终:'+endPlace, resultPoi:results.getEnd()});
                            }

                            paths.push(results.getPlan(0).getRoute(0).getPath());

                            distances.push(results.getPlan(0).getDistance(false));
                            durations.push(results.getPlan(0).getDuration(false));

                            searchNextDrivingRoute(++i);
                        } else {
                            map.clearOverlays();
                            window.core.updateMapDriveRoute(usrData, false, 0, 0);
                        }
                    });
                } else {
                    map.clearOverlays();

                    var viewPortPoints = [];
                    for(var i=0; i<endpoints.length; i++) {

                        var placePrefix = endpoints[i].place.substr(0, endpoints[i].place.indexOf(':'));
                        var label = new BMap.Label(placePrefix, {offset: new BMap.Size((placePrefix.length <= 1 ? 5:2), 3),});
                        label.setStyle({background: 'none', color: 'floralwhite', border: 'none',});

                        var marker = new BMap.Marker(endpoints[i].resultPoi.point, {
                            title: endpoints[i].place,
                            enableDragging: true,
                            //raiseOnDrag: true,
                        });
                        marker.setLabel(label);

                        map.addOverlay(marker);

                        viewPortPoints.push(endpoints[i].resultPoi.point);
                    }

                    var colors = ['#cc3300','#33cc00','#3366ff','#cc00cc'];
                    for(var i=0; i<paths.length; i++) {
                        var polyline = new BMap.Polyline(paths[i], {
                            strokeColor: colors[i%colors.length],
                            strokeOpacity: 0.8,
                            strokeWeight: 5,
                        });
                        polyline.addEventListener('mouseover', function(e){
                            e.target.setStrokeWeight(8);
                        });
                        polyline.addEventListener('mouseout', function(e){
                            e.target.setStrokeWeight(5);
                        });
                        map.addOverlay(polyline);
                    }

                    map.setViewport(viewPortPoints);

                    window.core.updateMapDriveRoute(usrData, true, distances.toString(), durations.toString());
                }
            }
            searchNextDrivingRoute(0);
        });
    });

    map.addEventListener("mousemove", function(e) {
        window.core.updateMapMousePosition(e.point.lng,e.point.lat);
    });

</script>
