<!DOCTYPE html>
<html>
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script type='text/javascript' src='./qwebchannel.js'></script>
        <script type='text/javascript' src='http://api.map.baidu.com/api?v=1.2&ak=gtUDcX7BrzZADD2dWMFE1RgF6IkL3t2I'></script>
    </head>

    <body>
        <div>
            <div>
                <script>
                    function onDrive() {
                        map.clearOverlays();
                        var startPlace = document.getElementById('startInput').value;
                        var endPlace = document.getElementById("endInput").value;
                        searchDrivingRoute(startPlace, endPlace, false, function(success, results) {
                            if(success) {
                                document.getElementById("places").innerText = startPlace + ', ' + endPlace;
                                document.getElementById("result").innerText = '总共：' + results.getPlan(0).getDistance() + ', 需要：' + results.getPlan(0).getDuration();
                            }
                        });
                    }
                </script>

                从&nbsp;<input id="startInput" type="text" value="广州体育中心"/>&nbsp;到&nbsp;<input id="endInput" type="text" value="广州火车站"/>&nbsp;&nbsp;<input type="button" value="路线规划" onclick="onDrive()"/>
                <div id="result">&nbsp;</div>
                <div id="places">&nbsp;</div>
            </div>
        </div>
        <div id="mapContainer" style="width:600px;height:480px;top:2px;"></div>
        <div id="routePanel" style="position:absolute;left:600px;top:2px;"></div>
    </body>

</html>

<script type="text/javascript">
    "use strict";

    var map = new BMap.Map("mapContainer");                 // 创建Map实例
    var point = new BMap.Point(113.30764968, 23.1200491);   // 创建点坐标
    map.centerAndZoom(point, 12);                           // 初始化地图,设置中心点坐标和地图级别。
    map.enableScrollWheelZoom();                            // 启用滚轮放大缩小
    map.enableKeyboard();                                   // 启用键盘操作
    map.enableContinuousZoom();                             // 启用连续缩放
    map.addControl(new BMap.ScaleControl());                // 添加比例尺控件
    map.addControl(new BMap.NavigationControl());           // 添加地图导航尺
    map.addControl(new BMap.OverviewMapControl());          // 添加缩略地图控件
/*
    (new BMap.Geolocation()).getCurrentPosition(function(geo) {
        if(geo != null) { map.panTo(geo.point); }
    });*/

    function searchDrivingRoute(startPlace, endPlace, autoClear, reslutCallback) {
        //if((typeof startPlace != 'string') || (typeof endPlace != 'string') || (typeof reslutCallback != 'function'))

        var drivingRoute = new BMap.DrivingRoute(map, {renderOptions:{map: map, autoViewport: true}});

        drivingRoute.setSearchCompleteCallback(function(results) {
            if(reslutCallback != null) {
                reslutCallback(true, results);
            }
            if(autoClear) {
                drivingRoute.clearResults();
            }
        });

        var startPoint = null;
        var endPoint = null;

        //创建2个搜索实例
        var searchStartPoint = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                if (searchStartPoint.getStatus() == BMAP_STATUS_SUCCESS) { // 判断状态是否正确
                    startPoint = results.getPoi(0).point;
                } else {
                    if(reslutCallback != null) {
                        reslutCallback(false);
                    }
                }
                if((startPoint != null) && (endPoint != null)) {
                    drivingRoute.search(startPoint, endPoint);
                }
            }
        });
        var searchEndPoint = new BMap.LocalSearch(map, {
            onSearchComplete: function(results) {
                if (searchEndPoint.getStatus() == BMAP_STATUS_SUCCESS) {
                    endPoint = results.getPoi(0).point;
                } else {
                    if(reslutCallback != null) {
                        reslutCallback(false);
                    }
                }
                if((startPoint != null) && (endPoint != null)) {
                    drivingRoute.search(startPoint, endPoint);
                }
            }
        });

        searchStartPoint.search(startPlace);
        searchEndPoint.search(endPlace);
    }

    new QWebChannel(window.qt.webChannelTransport, function(channel) {
        window.core = channel.objects.Mainwindow;

        window.core.getMapDriveRoute.connect(function(usrData, startPlace, endPlace) {
            searchDrivingRoute(startPlace, endPlace, true, function(success, results) {
                window.core.updateMapDriveRoute(usrData, success ? (results.getNumPlans() > 0) : false,
                                                         success ? results.getPlan(0).getDistance():0,
                                                         success ? results.getPlan(0).getDuration():0);
            });
        });

        window.core.getMapDriveRoutes.connect( function(usrData, placeSet, seq) {
            var placeList = placeSet.split(seq);

            document.getElementById("places").innerText = placeList;
            //var calculatingWindow = window.showModalDialog();

            var paths = [];
            var endpoints = [];

            var totalDistance = 0;
            var totalDuration = 0;
            function searchNextDrivingRoute(i) {
                if(i <= placeList.length-2) {
                    var startPlace = placeList[i].trim();
                    var endPlace = placeList[i+1].trim();
                    searchDrivingRoute(startPlace, endPlace, true, function(success, results) {
                        if(success) {
                            if(i == 0) {
                                endpoints.push({place: '起点:'+startPlace, resultPoi:results.getStart()});
                            }
                            if(i < placeList.length-2) {
                                endpoints.push({place: (i+1)+':'+endPlace, resultPoi:results.getEnd()});
                            } else {
                                endpoints.push({place: '终点:'+endPlace, resultPoi:results.getEnd()});
                            }

                            paths.push(results.getPlan(0).getRoute(0).getPath());

                            totalDistance += results.getPlan(0).getDistance(false); // unit: meter
                            totalDuration += results.getPlan(0).getDuration(false); // unit: second
                        }
                        searchNextDrivingRoute(++i);
                    });
                } else {
                    map.clearOverlays();

                    var viewPortPoints = [];
                    for(var i=0; i<endpoints.length; i++) {

                        map.addOverlay(new BMap.Marker(endpoints[i].resultPoi.point));
                        map.addOverlay(new BMap.Label(endpoints[i].place, {offset: new BMap.Size(0, 0), position: endpoints[i].resultPoi.point}));

                        viewPortPoints.push(endpoints[i].resultPoi.point);
                    }

                    for(var i=0; i<paths.length; i++) {
                        var polyline = new BMap.Polyline(paths[i]);
                        map.addOverlay(polyline);
                    }

                    map.setViewport(viewPortPoints);

                    window.core.updateMapDriveRoute(usrData, (totalDistance > 0), totalDistance, totalDuration);
                }
            }
            searchNextDrivingRoute(0);
        });
    });

    map.addEventListener("mousemove", function(e) {
        window.core.updateMapMousePosition(e.point.lng,e.point.lat);
    });

</script>
